name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "*" ]

jobs:
  email-service-tests:
    name: Email Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go Environment
      uses: ./.github/actions/setup
    
    - name: Initialize Go Workspace
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work sync
    
    - name: Start MailHog
      run: docker run -d --name mailhog -p 1025:1025 -p 8025:8025 mailhog/mailhog:latest
    
    - name: Wait for MailHog
      run: sleep 5
    
    - name: Run Email Service Tests
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work use ./services/email
        go test -v email-service/tests/...

  subscription-service-tests:
    name: Subscription Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go Environment
      uses: ./.github/actions/setup
    
    - name: Initialize Go Workspace
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work sync
    
    - name: Start PostgreSQL
      run: |
        docker run -d --name postgres-subscription \
          -e POSTGRES_DB=subscription_test \
          -e POSTGRES_USER=test \
          -e POSTGRES_PASSWORD=test \
          -p 5432:5432 \
          postgres:15
    
    - name: Start MailHog
      run: docker run -d --name mailhog-subscription -p 1026:1025 -p 8026:8025 mailhog/mailhog:latest
    
    - name: Wait for services
      run: sleep 10
    
    - name: Run Subscription Service Tests
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work use ./services/subscription
        go test -v subscription-service/tests/...

  token-service-tests:
    name: Token Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go Environment
      uses: ./.github/actions/setup
    
    - name: Initialize Go Workspace
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work sync
    
    - name: Run Token Service Tests
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work use ./services/token
        go test -v token-service/tests/...

  weather-broadcast-service-tests:
    name: Weather Broadcast Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go Environment
      uses: ./.github/actions/setup
    
    - name: Initialize Go Workspace
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work sync
    
    - name: Run Weather Broadcast Service Tests
      env:
        GO111MODULE: on
        GOPROXY: direct
        GOSUMDB: off
        GOPATH: ${{ github.workspace }}/go
      run: |
        go work use ./services/weather-broadcast
        go test -v weather-broadcast-service/tests/...