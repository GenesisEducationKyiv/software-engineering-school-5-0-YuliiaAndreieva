name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "*" ]

jobs:
  email-service-tests:
    name: Email Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Download dependencies for Email Service
      run: |
        cd services/email
        go mod download
        go mod tidy
    
    - name: Install mockery
      run: go install github.com/vektra/mockery/v2@latest
    
    - name: Generate Mocks for Email Service
      run: |
        cd services/email
        mockery --all --output tests/mocks --outpkg mocks
    
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-email-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-email-
          ${{ runner.os }}-buildx-
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Run Email Service Tests
      run: |
        cd services/email
        docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from email-service-tests

  subscription-service-tests:
    name: Subscription Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Download dependencies for Subscription Service
      run: |
        cd services/subscription
        go mod download
        go mod tidy
    
    - name: Install mockery
      run: go install github.com/vektra/mockery/v2@latest
    
    - name: Generate Mocks for Subscription Service
      run: |
        cd services/subscription
        mockery --all --output tests/mocks --outpkg mocks
    
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-subscription-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-subscription-
          ${{ runner.os }}-buildx-
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Run Subscription Service Tests
      run: |
        cd services/subscription
        docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from subscription-service-tests

  token-service-tests:
    name: Token Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Download dependencies for Token Service
      run: |
        cd services/token
        go mod download
        go mod tidy
    
    - name: Install mockery
      run: go install github.com/vektra/mockery/v2@latest
    
    - name: Generate Mocks for Token Service
      run: |
        cd services/token
        mockery --all --output tests/mocks --outpkg mocks
    
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-token-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-token-
          ${{ runner.os }}-buildx-
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Run Token Service Tests
      run: |
        docker build -f services/token/Dockerfile.test -t token-service-tests .
        docker run --rm token-service-tests

  weather-broadcast-service-tests:
    name: Weather Broadcast Service Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Download dependencies for Weather Broadcast Service
      run: |
        cd services/weather-broadcast
        go mod download
        go mod tidy
    
    - name: Install mockery
      run: go install github.com/vektra/mockery/v2@latest
    
    - name: Generate Mocks for Weather Broadcast Service
      run: |
        cd services/weather-broadcast
        mockery --all --output tests/mocks --outpkg mocks
    
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-weather-broadcast-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-weather-broadcast-
          ${{ runner.os }}-buildx-
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Start PostgreSQL
      run: |
        docker network create weather-broadcast-test-network
        docker run -d --name postgres-weather-broadcast \
          --network weather-broadcast-test-network \
          -e POSTGRES_DB=weather_broadcast_test \
          -e POSTGRES_USER=test \
          -e POSTGRES_PASSWORD=test \
          -p 5432:5432 \
          postgres:15
    
    - name: Start MailHog
      run: |
        docker run -d --name mailhog-weather-broadcast \
          --network weather-broadcast-test-network \
          -p 1027:1025 \
          -p 8027:8025 \
          mailhog/mailhog:latest
    
    - name: Wait for services
      run: sleep 10
    
    - name: Run Weather Broadcast Service Tests
      run: |
        docker build -f services/weather-broadcast/Dockerfile.test -t weather-broadcast-service-tests .
        docker run --rm \
          --network weather-broadcast-test-network \
          -e TEST_DB_HOST=postgres-weather-broadcast \
          -e TEST_DB_PORT=5432 \
          -e TEST_DB_USER=test \
          -e TEST_DB_PASSWORD=test \
          -e TEST_DB_NAME=weather_broadcast_test \
          -e MAILHOG_HOST=mailhog-weather-broadcast \
          -e MAILHOG_PORT=1025 \
          -e MAILHOG_WEB_PORT=8025 \
          -e SMTP_HOST=mailhog-weather-broadcast \
          -e SMTP_PORT=1025 \
          weather-broadcast-service-tests