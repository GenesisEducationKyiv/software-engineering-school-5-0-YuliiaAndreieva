FROM golang:1.24-alpine

WORKDIR /app

# Copy shared and proto modules
COPY proto/ ./proto/
COPY shared/ ./shared/
COPY services/subscription/go.mod services/subscription/go.sum ./

# Fix replace directives for Docker context
RUN awk '{gsub("../../proto", "./proto"); gsub("../../shared", "./shared"); print}' go.mod > go.mod.tmp && \
    mv go.mod.tmp go.mod

# Copy subscription service source code
COPY services/subscription/ ./

# Download dependencies
RUN go mod tidy
RUN go mod download

# Run tests
CMD ["go", "test", "-v", "./tests/..."] 